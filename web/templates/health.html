{% extends "base.html" %}

{% block title %}시스템 상태 - AI Medical A2A{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="text-center mb-4">
            <i class="fas fa-heartbeat" style="color: var(--success-color);"></i> 시스템 상태
        </h1>
    </div>
</div>

{% if status == "success" %}
<div class="row">
    <div class="col-md-4">
        <!-- 전체 시스템 상태 -->
        <div class="card mb-4">
            <div class="card-header bg-{% if health_data.status == 'healthy' %}success{% elif health_data.status == 'degraded' %}warning{% else %}danger{% endif %} text-white">
                <h4 class="card-title mb-0">
                    <i class="fas fa-server"></i> 전체 시스템 상태
                </h4>
            </div>
            <div class="card-body text-center">
                <h2 class="{% if health_data.status == 'healthy' %}text-success{% elif health_data.status == 'degraded' %}text-warning{% else %}text-danger{% endif %}">
                    {% if health_data.status == 'healthy' %}
                        <i class="fas fa-check-circle"></i> 정상
                    {% elif health_data.status == 'degraded' %}
                        <i class="fas fa-exclamation-triangle"></i> 부분 장애
                    {% else %}
                        <i class="fas fa-times-circle"></i> 장애
                    {% endif %}
                </h2>
                <p class="text-muted">
                    마지막 확인: {{ health_data.orchestrator_info.timestamp | datetime }}
                </p>
            </div>
        </div>
    </div>
    
    <div class="col-md-8">
        <!-- 개별 에이전트 상태 -->
        <div class="row">
            <!-- DR_BLADDER 상태 -->
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header" style="background: linear-gradient(135deg, #17a2b8, #138496); color: white;">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-user-md"></i> DR_BLADDER
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if health_data.agents.bladder.status == 'healthy' %}
                            <div class="text-center">
                                <i class="fas fa-check-circle text-success fa-3x mb-3"></i>
                                <h4 class="text-success">정상</h4>
                                <p class="text-muted">{{ health_data.agents.bladder.data.message }}</p>
                            </div>
                        {% elif health_data.agents.bladder.status == 'degraded' %}
                            <div class="text-center">
                                <i class="fas fa-exclamation-triangle text-warning fa-3x mb-3"></i>
                                <h4 class="text-warning">부분 장애</h4>
                                <p class="text-muted">{{ health_data.agents.bladder.message }}</p>
                            </div>
                        {% else %}
                            <div class="text-center">
                                <i class="fas fa-times-circle text-danger fa-3x mb-3"></i>
                                <h4 class="text-danger">장애</h4>
                                <p class="text-muted">{{ health_data.agents.bladder.error }}</p>
                            </div>
                        {% endif %}
                    </div>
                    <div class="card-footer">
                        <small class="text-muted">
                            <i class="fas fa-network-wired"></i> Port: 8001
                        </small>
                    </div>
                </div>
            </div>
            
            <!-- DR_PROSTATE 상태 -->
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header" style="background: linear-gradient(135deg, #ffc107, #e0a800); color: #212529;">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-user-md"></i> DR_PROSTATE
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if health_data.agents.prostate.status == 'healthy' %}
                            <div class="text-center">
                                <i class="fas fa-check-circle text-success fa-3x mb-3"></i>
                                <h4 class="text-success">정상</h4>
                                <p class="text-muted">{{ health_data.agents.prostate.data.message }}</p>
                            </div>
                        {% elif health_data.agents.prostate.status == 'degraded' %}
                            <div class="text-center">
                                <i class="fas fa-exclamation-triangle text-warning fa-3x mb-3"></i>
                                <h4 class="text-warning">부분 장애</h4>
                                <p class="text-muted">{{ health_data.agents.prostate.message }}</p>
                            </div>
                        {% else %}
                            <div class="text-center">
                                <i class="fas fa-times-circle text-danger fa-3x mb-3"></i>
                                <h4 class="text-danger">장애</h4>
                                <p class="text-muted">{{ health_data.agents.prostate.error }}</p>
                            </div>
                        {% endif %}
                    </div>
                    <div class="card-footer">
                        <small class="text-muted">
                            <i class="fas fa-network-wired"></i> Port: 8002
                        </small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 오케스트레이터 상태 -->
        <div class="card">
            <div class="card-header" style="background: var(--gradient-primary); color: var(--text-light);">
                <h5 class="card-title mb-0">
                    <i class="fas fa-brain"></i> Medical Orchestrator
                </h5>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-3 text-center">
                        <i class="fas fa-check-circle text-success fa-3x"></i>
                        <h4 class="text-success mt-2">정상</h4>
                    </div>
                    <div class="col-md-9">
                        <table class="table table-sm table-borderless" style="color: var(--text-light);">
                            <tr>
                                <td><strong>모델:</strong></td>
                                <td>{{ health_data.agents.orchestrator.model }}</td>
                            </tr>
                            <tr>
                                <td><strong>버전:</strong></td>
                                <td>{{ health_data.orchestrator_info.version }}</td>
                            </tr>
                            <tr>
                                <td><strong>포트:</strong></td>
                                <td>8003</td>
                            </tr>
                            <tr>
                                <td><strong>상태:</strong></td>
                                <td><span class="badge" style="background: var(--success-color); color: white;">활성</span></td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 시스템 통계 -->
<div class="row mt-4">
    <div class="col-12">
        <h3><i class="fas fa-chart-bar"></i> 시스템 정보</h3>
    </div>
    
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h2 class="text-primary">3</h2>
                <p class="text-muted">활성 에이전트</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h2 class="text-success">
                    {% set healthy_count = 0 %}
                    {% for agent_name, agent_data in health_data.agents.items() %}
                        {% if agent_data.status == 'healthy' %}
                            {% set healthy_count = healthy_count + 1 %}
                        {% endif %}
                    {% endfor %}
                    {{ healthy_count }}
                </h2>
                <p class="text-muted">정상 상태</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h2 class="text-info">A2A</h2>
                <p class="text-muted">아키텍처</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h2 class="text-warning">AI</h2>
                <p class="text-muted">기반 기술</p>
            </div>
        </div>
    </div>
</div>

{% else %}
<!-- 오류 상태 -->
<div class="row">
    <div class="col-md-8 mx-auto">
        <div class="alert alert-danger text-center" role="alert">
            <h2><i class="fas fa-exclamation-triangle"></i> 시스템 연결 실패</h2>
            <p class="lead">의료 상담 시스템에 연결할 수 없습니다.</p>
            <hr>
            <p><strong>오류 세부사항:</strong></p>
            <code>{{ health_data.error }}</code>
            <div class="mt-3">
                <button onclick="location.reload()" class="btn btn-outline-danger">
                    <i class="fas fa-redo"></i> 다시 시도
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- 새로고침 및 액션 -->
<div class="row mt-4">
    <div class="col-12 text-center">
        <button onclick="location.reload()" class="btn btn-outline-primary" style="border-color: var(--accent-blue); color: var(--accent-blue);">
            <i class="fas fa-redo"></i> 상태 새로고침
        </button>
        <a href="{{ url_for('consultation') }}" class="btn btn-primary">
            <i class="fas fa-comments"></i> 상담 시작하기
        </a>
    </div>
</div>

<!-- 도움말 -->
<div class="row mt-5">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-question-circle"></i> 상태 지표 설명
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <h6><i class="fas fa-check-circle text-success"></i> 정상 (Healthy)</h6>
                        <p class="small text-muted">모든 기능이 정상적으로 작동하고 있습니다.</p>
                    </div>
                    <div class="col-md-4">
                        <h6><i class="fas fa-exclamation-triangle text-warning"></i> 부분 장애 (Degraded)</h6>
                        <p class="small text-muted">일부 기능에 제한이 있지만 기본 동작은 가능합니다.</p>
                    </div>
                    <div class="col-md-4">
                        <h6><i class="fas fa-times-circle text-danger"></i> 장애 (Unhealthy)</h6>
                        <p class="small text-muted">서비스가 중단되었거나 접근할 수 없습니다.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// 자동 새로고침 (30초마다)
setInterval(function() {
    const refreshButton = document.querySelector('button[onclick="location.reload()"]');
    if (refreshButton) {
        refreshButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 새로고침 중...';
        setTimeout(() => {
            location.reload();
        }, 1000);
    }
}, 30000);

// 페이지 로드 시 상태 카드 애니메이션
document.addEventListener('DOMContentLoaded', function() {
    const cards = document.querySelectorAll('.card');
    cards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            card.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 100);
    });
});
</script>
{% endblock %}